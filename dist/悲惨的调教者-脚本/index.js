function t(t,e){return t>0?Math.min(t,e.最大增值??1/0):t<0?Math.max(t,e.最大减值??-1/0):0}eventOn(tavern_events.MESSAGE_RECEIVED,async e=>{console.log(`正在处理第${e}条消息`);let a=getChatMessages(e)[0].message;const r=a.match(/<VariableEdit>((?:(?!<VariableEdit>)[\s\S])*?)<\/VariableEdit>(?![\s\S]*<VariableEdit>[\s\S]*<\/VariableEdit>)/);if(r)try{const e=r[1].trim(),n=JSON.parse(e);console.log('捕获到 VariableEdit 数据:',n);const s=getVariables({type:'chat'}).stat_data;console.log('最新的 stat_data :',s);const i=function(e,a){const r=JSON.parse(JSON.stringify(a)),n=e.数值变化限制||{好感度:{最大增值:20,最大减值:0},暴露度:{最大增值:10,最大减值:-5},经验值:{最大增值:30,最大减值:0}};return a.角色&&e.角色?(Object.keys(a.角色).forEach(s=>{const i=e.角色[s],o=a.角色[s];if(!i||!o||!i.特殊状态)return;const c=i.特殊状态,l=o.特殊状态||{};if('number'==typeof l.好感度){const e=t(l.好感度-(c.好感度||0),n.好感度),a=Math.max(0,(c.好感度||0)+e);r.角色[s].特殊状态||(r.角色[s].特殊状态={}),r.角色[s].特殊状态.好感度=a}if('number'==typeof l.暴露度){const e=t(l.暴露度-(c.暴露度||0),n.暴露度),a=Math.max(0,(c.暴露度||0)+e);r.角色[s].特殊状态||(r.角色[s].特殊状态={}),r.角色[s].特殊状态.暴露度=a}if('number'==typeof l.调教经验值){const a=t(l.调教经验值-(c.调教经验值||0),n.经验值);let i=Math.max(0,(c.调教经验值||0)+a),o=e.调教等级||0;for(;i>=4*(o+1);)i-=4*(o+1),o+=1;r.角色[s].特殊状态||(r.角色[s].特殊状态={}),r.角色[s].特殊状态.调教经验值=i,r.调教等级=o}['胸部','小穴','口穴','菊穴'].forEach(e=>{const a=c.开发经验值?.[e]||0,i=l.开发经验值?.[e];if('number'!=typeof i)return;const o=t(i-a,n.经验值);let f=Math.max(0,a+o);r.角色[s].特殊状态.开发经验值||(r.角色[s].特殊状态.开发经验值={}),r.角色[s].特殊状态.开发经验值[e]=f,r.身体开发等级||(r.身体开发等级={}),r.身体开发等级[s]||(r.身体开发等级[s]={}),r.身体开发等级[s][e]=function(t){const e=[0,5,15,25,35,50,100];for(let a=e.length-1;a>=0;a--)if(t>=e[a])return a;return 0}(f)})}),r):r}(s,n),o=JSON.stringify(i,null,2);a=a.replace(/<VariableEdit>[\s\S]*?<\/VariableEdit>/,`<VariableEdit>\n${o}\n</VariableEdit>`),console.log('数据更新完成',i)}catch(t){toastr.error('VariableEdit JSON 解析错误'),console.error('VariableEdit JSON 解析错误:',t)}await setChatMessages([{message_id:e,message:a}])});